<?= $this->headLink()->appendStylesheet('/css/report.css') ?>
<?php
$this->headScript()->appendFile(
    '/js/report.js?v=6',
    'text/javascript'
); ?>

<h1>
    <?php if (empty($system)): ?>
        Report of National Aggregate Data
    <?php else: ?>
        <?= $system->getName() ?> Report
    <?php endif ?>
</h1>

<ul class="nav nav-pills report-nav">
    <?php foreach ($subscriptions as $subscription): ?>
        <?php if ($subscription->getYear() == $this->currentStudy()->getCurrentYear() && !$this->currentStudy()->getReportsOpen()) continue; ?>
        <li<? if ($subscription->getYear() == $year) echo ' class="active"' ?>>
            <a href="<?= $this->url('reports/' . $reportPath, array('year' => $subscription->getYear())) ?>"><?= $subscription->getYear() ?></a>
        </li>
    <?php endforeach ?>
</ul>


<p>
    Prepared for <?= $college->getName() ?>
</p>

<p>
    <a href="<?= $this->url(
        'reports/' . $reportPath,
        array(
            'year' => $year,
            'format' => 'excel'
        )
    ) ?>" class="btn btn-default">
        <span class="glyphicon glyphicon-circle-arrow-down"></span>
        Download Report
    </a>

    <a href="<?= $this->url(
        'institution/subscribed',
        array(
            'year' => $year
        )
    ) ?>" class="btn btn-default">
        <span class="glyphicon glyphicon-circle-arrow-down"></span>
        Download Members
    </a>
</p>

<div class="report">

    <?php foreach ($reportData as $benchmarkGroup): ?>
        <?php if (stristr($benchmarkGroup['benchmarkGroup'], '|')): ?>
            <?php list($formNumber, $formTitle) = explode(' | ', $benchmarkGroup['benchmarkGroup']) ?>
        <?php elseif (stristr($benchmarkGroup['benchmarkGroup'], ':')): ?>
            <?php $nameParts = explode(': ', $benchmarkGroup['benchmarkGroup']) ?>
            <?php $formNumber = array_shift($nameParts) ?>
            <?php $formTitle = implode(': ', $nameParts) ?>
        <?php endif ?>
        <h3 class="benchmarkGroupTitle" id="form_<?= $benchmarkGroup['url'] ?>">
            <span class="small-heading"><?= $formNumber ?></span><br>
            <?= $formTitle ?>
            <?php if (!empty($benchmarkGroup['timeframe'])): ?>
                <span class="timeframe">(<?= $benchmarkGroup['timeframe'] ?>)</span>
            <?php endif ?>

        </h3>

        <?php if (empty($system)) {
            $heading = 'National Percentiles';
        } else {
            $heading = 'System Percentiles';
        }?>

        <table class="table table-hover table-striped-manual">
            <thead>
                <tr class="topHeading">
                    <th></th>
                    <th colspan="2">Your Institution</th>
                    <th colspan="7" class="nationalPercentiles"><?= $heading ?></th>
                </tr>
                <tr class="secondHeading">
                    <th></th>
                    <th>Reported Value</th>
                    <th>% Rank</th>
                    <th>N</th>
                    <?php foreach ($breakpoints as $breakpoint): ?>
                    <th><?= $breakpoint ?></th>
                    <?php endforeach ?>
                    <th><a href="#" class="btn btn-default showAllCharts" title="Display all charts"><i class="icon-signal glyphicon glyphicon-signal"></i></a></th>
                </tr>
            </thead>

            <tbody>
                <?php foreach ($benchmarkGroup['benchmarks'] as $benchmark): ?>
                    <?php if (!empty($benchmark['heading'])): ?>
                        <tr class="retportSeparator"></tr>
                        <tr class="reportSubHeading">
                            <td colspan="10">
                                <?= $benchmark['name'] ?>
                            </td>
                        </tr>
                        <?php continue ?>
                    <?php endif; ?>

                    <?php $rowClass = $this->cycle(array('odd', 'even'))->next() ?>
                    <tr class="<?= $rowClass ?>">
                        <td class="benchmarkLabel">
                            <?= $benchmark['benchmark'] ?>
                            <?php if (!empty($benchmark['timeframe'])): ?>
                                <span class="timeframe">(<?= $benchmark['timeframe'] ?>)</span>
                            <?php endif ?>
                        </td>
                        <?php if ($benchmark['reported'] !== null): ?>
                        <td><?= $benchmark['prefix'] . number_format($benchmark['reported'], $benchmark['reported_decimal_places']) . $benchmark['suffix'] ?></td>
                        <td class="percentileColor">
                            <?php if (!empty($benchmark['do_not_format_rank'])): ?>
                                <?= $benchmark['percentile_rank'] ?>
                            <?php else: ?>
                                <?= round($benchmark['percentile_rank']) ?>%
                            <?php endif ?>
                        </td>
                        <?php else: ?>
                            <td>-</td>
                            <td>-</td>
                        <?php endif ?>
                        <td><?= $benchmark['N'] ?></td>
                        <?php foreach ($benchmark['percentiles'] as $percentile): ?>
                        <td>
                            <?php if (!is_null($percentile)): ?>
                                <?= $benchmark['prefix'] . number_format($percentile, $benchmark['reported_decimal_places']) . $benchmark['suffix'] ?>
                            <?php endif ?>
                        </td>
                        <?php endforeach ?>
                        <td><a href="#" class="btn btn-default openChart" title="Display chart"><i class="icon-signal glyphicon glyphicon-signal"></i></a></td>
                    </tr>
                    <tr class="nationalReportChart <?= $rowClass ?>" id="benchmark_<?= $benchmark['dbColumn'] ?>">
                        <td></td>
                        <td colspan="9">
                            <?= $this->chart($benchmark['chart']) ?>

                            <?php if (!empty($benchmark['description'])): ?>
                            <p class="nationalDataDefinition">
                                <?= $benchmark['description'] ?>
                            </p>
                            <?php endif ?>
                        </td>
                    </tr>

                <?php endforeach ?>
            </tbody>
            <thead>
                <tr class="spacerRow">
                    <td colspan="9"></td>
                </tr>
            </thead>
        </table>
        <hr>
    <?php endforeach ?>


    <p class="footnote" id="bottom">
        - = % Rank cannot be reported on a zero.
    </p>
</div>
