<?php
$this->headScript()->appendFile(
    '/js/report-calculation.js?v=4',
    'text/javascript'
); ?>

<?php /** @var \Mrss\Entity\Study $study */ ?>
<script>
    var benchmarks = {};

    <?php foreach ($years as $year => $calculationDates) {
        $benchmarkIdsForYear = array();
        /*foreach ($study->getBenchmarksForYear($year) as $benchmark) {
            $benchmarkIdsForYear[] = $benchmark->getId();
        }*/

        $benchmarkIdsForYear = $benchmarkIds[$year];


    ?>
        benchmarks[<?= $year ?>] = <?= json_encode($benchmarkIdsForYear) ?>;

    <?php } ?>

    var observations = <?= json_encode($observationIds) ?>;

    var systemIds = <?= json_encode($systemIds) ?>;

</script>

<style>
    h3 {
       margin-top: 25px;
    }
    .calculation-progress, .system-progress {
        display: none;
    }
</style>

<h1>Calculate Reports</h1>

<?php foreach ($years as $year => $calculationDates): ?>
    <h2><?= $year ?></h2>

    <h3>Outlier Report</h3>
    <div class="row-fluid row">
        <div class="span6 col-md-4">
            <p>
                Calculate outlier and missing data.
            </p>

            <p>
                <a href="/admin/outliers">View Admin Outlier Report</a>
            </p>
        </div>

        <div class="span6 col-md-5" id="outlier-progress-<?= $year ?>">
            <div class="progress calculation-progress">
                <div class="bar progress-bar"
                     role="progressbar"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     style="width: 0%;"></div>
            </div>

        </div>

        <div class="col-md-1">
            <span class="progress-label"></span>
        </div>

        <div class="span6 col-md-2">
            <?php if (false): ?>
                <a class="btn btn-default" href="/reports/calculateOutliers/year/<?= $year ?>">Prepare Outlier Report</a>
            <?php else: ?>
                <a class="btn btn-default calculate-outliers" id="outlier-<?= $year ?>" href="#">Prepare Outlier Report</a>
            <?php endif ?>

            <br>
            <?php if (!empty($calculationDates['outliers'])): ?>
                Prepared on <?= $calculationDates['outliers'] ?>
                <br>
                <br>
                <a class="btn btn-default" href="/reports/emailOutliers/preview" >Preview Outlier Emails</a>
                <a class="btn btn-default" href="/reports/emailOutliers" onclick="return confirm('Are you sure you want to send outlier report emails to all member institutions?')">Send Outlier Emails</a>
            <?php else: ?>
                Not yet prepared.
            <?php endif ?>

        </div>
    </div>

    <h3>Compute Benchmarks</h3>
    <div class="row-fluid row">
        <div class="span6 col-md-4">
            <p>
                Run equations for computed benchmarks and store results.
            </p>

        </div>

        <div class="span6 col-md-5" id="compute-progress-<?= $year ?>">
            <div class="progress calculation-progress">
                <div class="bar progress-bar"
                     role="progressbar"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     style="width: 0%;"></div>
            </div>

        </div>

        <div class="col-md-1">
            <span class="progress-label"></span>
        </div>

        <div class="span6 col-md-2">
            <a class="btn btn-default calculate-compute" id="compute-<?= $year ?>" href="#">Compute Benchmarks</a>
            <br>
            <?php /* if (!empty($calculationDates['report'])): ?>
                Prepared on <?= $calculationDates['report'] ?>
            <?php else: ?>
                Not yet prepared.
            <?php endif */ ?>

        </div>
    </div>

    <h3>National Report</h3>
    <div class="row-fluid row">
        <div class="span6 col-md-4">
            <p>
                Calculate percentiles for National Report.
            </p>

            <p>
                <a href="/reports/national">View National Report</a>
            </p>
        </div>

        <div class="span6 col-md-5" id="percentile-progress-<?= $year ?>">
            <div class="progress calculation-progress">
                <div class="bar progress-bar"
                     role="progressbar"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     style="width: 0%;"></div>
            </div>

        </div>

        <div class="col-md-1">
            <span class="progress-label"></span>
        </div>



        <div class="span6 col-md-2">
            <?php if (false): ?>
                <a class="btn btn-default" href="/reports/calculate/year/<?= $year ?>">Prepare National Report</a>
            <?php else: ?>
                <a class="btn btn-default calculate-percentile" href="#" id="calculate-percentile-<?= $year ?>">Prepare National Report</a>
            <?php endif ?>
            <br>
            <?php if (!empty($calculationDates['report'])): ?>
                Prepared on <?= $calculationDates['report'] ?>
            <?php else: ?>
                Not yet prepared.
            <?php endif ?>

        </div>
    </div>

    <h3>System Reports</h3>
    <div class="row-fluid row">
        <div class="span6 col-md-4">
            <p>
                Calculate percentiles for System Reports.
            </p>

        </div>

        <div class="span6 col-md-5" id="system-progress-<?= $year ?>">
            <div class="progress system-progress">
                <div class="bar progress-bar"
                     role="progressbar"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     style="width: 0%;"></div>
            </div>

        </div>

        <div class="col-md-1">
            <span class="progress-label"></span>
        </div>



        <div class="span6 col-md-2">
            <a class="btn btn-default calculate-systems" id="calculate-systems-<?= $year ?>" href="#<?php /*/reports/calculateSystems/year/<?= $year ?> */ ?>">Prepare System Reports</a>
            <br>
            <?php if (!empty($calculationDates['system'])): ?>
                Prepared on <?= $calculationDates['system'] ?>
            <?php else: ?>
                Not yet prepared.
            <?php endif ?>

        </div>
    </div>


<?php endforeach ?>
