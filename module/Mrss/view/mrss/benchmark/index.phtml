<script type="text/javascript" src="/js/jquery.sparkline.min.js"></script>
<script type="text/javascript">
    $(function() {
        // Make benchmrks sortable
        $('tbody.sortable').sortable({
            handle: '.sortHandle',
            update: function(event, ui) {
                parent = ui.item.parent()

                var benchmarkGroupId = parent.attr('id').split('_').pop()

                var benchmarkIds = [];
                parent.find('tr').each(function() {
                    benchmarkIds.push(parseInt($(this).attr('id').split('_').pop()))
                })

                data = {
                    benchmarkGroupId: benchmarkGroupId,
                    benchmarks: benchmarkIds
                }

                $.post('/benchmark/reorder', data, function(result) {
                    //console.log(result)
                    if (result != 'ok') {
                        alert('There was a problem saving your sequence.');
                    }
                })
            }
        })

        // Add sparklines
        $.fn.sparkline.defaults.line.minSpotColor = false;
        $.fn.sparkline.defaults.line.maxSpotColor = false;
        $.fn.sparkline.defaults.line.spotColor = false;
        $('.inlinesparkline').sparkline();
    })
</script>

<h2><?= $study->getName() ?> Benchmarks</h2>

<ul class="studyControls">
    <li>
        <a href="<?= $this->url(
            'benchmarkgroups/add',
            array('study' => $study->getId())
        )?>">
            <span class="icon-plus-sign"></span>
            Add a benchmark group
        </a>
    </li>
    <li>
        <a href="<?= $this->url(
            'studies/export',
            array('id' => $study->getId())
        ) ?>">
            <span class="icon-download"></span>
            Export benchmark setup to csv
        </a>
    </li>
    <li>
        <a href="<?= $this->url(
            'studies/import',
            array('id' => $study->getId())
        ) ?>" onclick="return confirm(
        'This will make permanent changes to the data. Are you sure you want to do this?')
        ">
            <span class="icon-upload"></span>
            Import benchmark setup from csv
        </a>
    </li>
</ul>

<h3>Forms</h3>
<?php foreach ($this->benchmarkGroups as $benchmarkGroup): ?>
<ul>
    <li><a href="#benchmarkGroup<?= $benchmarkGroup->getId() ?>"><?= $benchmarkGroup->getName() ?></a></li>
</ul>
<?php endforeach ?>

<?php foreach ($this->benchmarkGroups as $benchmarkGroup): ?>
    <h3 class="benchmarkGroupSection" id="benchmarkGroup<?= $benchmarkGroup->getId() ?>"><?= $benchmarkGroup->getName() ?></h3>

    <ul class="benchmarkGroupControls">
        <li>
            <span class="icon-cog"></span>
            <a href="<?= $this->url(
                'benchmarkgroups/edit',
                array('id' => $benchmarkGroup->getId())
            ) ?>">Benchmark group settings</a>
        </li>

        <li>
            <span class="icon-plus-sign"></span>
            <a href="<?= $this->url(
                'benchmark/add',
                array('benchmarkGroup' => $benchmarkGroup->getId())
            ) ?>">Add benchmark</a>
        </li>

        <li>
            <span class="icon-edit"></span>
            <a href="<?= $this->url(
                'data-entry/edit',
                array('benchmarkGroup' => $benchmarkGroup->getId())
            ) ?>">Data entry</a>
        </li>
    </ul>

    <h5>Benchmarks</h5>
    <table class="table table-striped table-hover heatmap">
        <thead>
            <tr>
                <th></th>
                <th>Variable Name</th>
                <th>Input<br>Type</th>
                <th>Computed</th>
                <th>On<br>Report</th>
                <th>Name</th>
                <th>Trends</th>

                <?php foreach ($this->yearsToShow as $year): ?>
                    <th><?= $year ?></th>
                <?php endforeach ?>
            </tr>
        </thead>
        <tbody class="sortable" id="benchmarkGroup_<?= $benchmarkGroup->getId() ?>">
        <?php foreach ($benchmarkGroup->getBenchmarks() as $benchmark): ?>
            <?php /** @var $benchmark \Mrss\Entity\Benchmark */ ?>
            <tr id="benchmark_<?= $benchmark->getId() ?>">
                <td class="sortHandle">
                    <span class="icon-move"></span>
                </td>
                <td>
                    <?= $benchmark->getDbColumn() ?>
                </td>

                <td class="inputTypeAbbr">
                    <?= $benchmark->getInputTypeAbbr() ?>
                </td>

                <td style="text-align:center">
                    <?php if ($benchmark->getComputed()): ?>
                        <i class="icon-ok infotip" title="<?= $benchmark->getEquation() ?>"></i>
                    <?php endif ?>
                </td>

                <td style="text-align:center">
                    <?php if ($benchmark->getIncludeInNationalReport()): ?>
                        <i class="icon-ok"></i>
                    <?php endif ?>
                </td>

                <td>
                    <a href="<?= $this->url(
                        'benchmark/edit',
                        array(
                            'id' => $benchmark->getId()
                        )
                    ) ?>"><?= $benchmark->getName() ?></a>
                </td>

                <td class="trends">
                    <a title="Showing <?= $activeCollege->getName() ?> values. Click for more trend data." href="<?= $this->url(
                        'benchmark/view',
                        array(
                            'id' => $benchmark->getId()
                        )
                    ) ?>">
                        <span class="inlinesparkline"><?= $sparklines[$benchmark->getId()] ?></span>
                    </a>
                </td>


                <?php foreach ($this->yearsToShow as $year): ?>
                    <td>
                        <?php if ($benchmark->isAvailableForYear($year)): ?>
                            <? $percentage = round(
                                $benchmark->getCompletionPercentage($year)
                            )?>
                            <div
                                class="heatmapCell heatmapCellBlue"
                                style="opacity: <?= $percentage / 100 ?>">
                                <?= $percentage ?>%
                            </div>
                        <?php else: ?>
                            <div style="color:#ccc; text-align:center">N/A</div>
                        <?php endif ?>
                    </td>
                <?php endforeach ?>
            </tr>
        <?php endforeach ?>
        </tbody>
    </table>
<?php endforeach ?>
