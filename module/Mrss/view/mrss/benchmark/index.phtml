<script type="text/javascript">
    $(function() {
        // Make benchmrks sortable
        $('tbody.sortable').sortable({
            update: function(event, ui) {
                parent = ui.item.parent()

                var benchmarkGroupId = parent.attr('id').split('_').pop()

                var benchmarkIds = [];
                parent.find('tr').each(function() {
                    benchmarkIds.push(parseInt($(this).attr('id').split('_').pop()))
                })

                data = {
                    benchmarkGroupId: benchmarkGroupId,
                    benchmarks: benchmarkIds
                }

                $.post('/benchmark/reorder', data, function(result) {
                    //console.log(result)
                    if (result != 'ok') {
                        alert('There was a problem saving your sequence.');
                    }
                })
            }
        })
    })
</script>

<h2><?= $study->getName() ?> Benchmarks</h2>

<ul>
    <li>
        <a href="<?= $this->url(
            'benchmarkgroups/add',
            array('study' => $study->getId())
        )?>">
            Add a benchmark group
        </a>
    </li>
    <li>
        <a href="<?= $this->url(
            'studies/export',
            array('id' => $study->getId())
        ) ?>">
            Export benchmark setup to csv
        </a>
    </li>
    <li>
        <a href="<?= $this->url(
            'studies/import',
            array('id' => $study->getId())
        ) ?>" onclick="return confirm(
        'This will make permanent changes to the data. Are you sure you want to do this?')
        ">
            Import benchmark setup from csv
        </a>
    </li>
</ul>

<?php foreach ($this->benchmarkGroups as $benchmarkGroup): ?>
    <h3><?= $benchmarkGroup->getName() ?></h3>

    <ul>
        <li>
            <a href="<?= $this->url(
                'benchmarkgroups/edit',
                array('id' => $benchmarkGroup->getId())
            ) ?>">Edit benchmark group</a>
        </li>

        <li>
            <a href="<?= $this->url(
                'benchmark/add',
                array('benchmarkGroup' => $benchmarkGroup->getId())
            ) ?>">Add benchmark</a>
        </li>
    </ul>

    <table class="table table-striped heatmap">
        <thead>
            <tr>
                <th>Benchmark</th>
                <th>Action</th>
                <?php foreach ($this->yearsToShow as $year): ?>
                    <th><?= $year ?></th>
                <?php endforeach ?>
            </tr>
        </thead>
        <tbody class="sortable" id="benchmarkGroup_<?= $benchmarkGroup->getId() ?>">
        <?php foreach ($benchmarkGroup->getBenchmarks() as $benchmark): ?>
            <tr id="benchmark_<?= $benchmark->getId() ?>">
                <td>
                    <a href="<?= $this->url(
                        'benchmark/view',
                        array(
                            'id' => $benchmark->getId()
                        )
                    ) ?>">
                        <?= $benchmark->getName() ?>
                    </a>
                </td>

                <td>
                    <a href="<?= $this->url(
                        'benchmark/edit',
                        array(
                            'id' => $benchmark->getId()
                        )
                    ) ?>">Edit</a>
                </td>

                <?php foreach ($this->yearsToShow as $year): ?>
                    <td>
                        <?php if ($benchmark->isAvailableForYear($year)): ?>
                            <? $percentage = round(
                                $benchmark->getCompletionPercentage($year)
                            )?>
                            <div
                                class="heatmapCell heatmapCellBlue"
                                style="opacity: <?= $percentage / 100 ?>">
                                <?= $percentage ?>%
                            </div>
                        <?php else: ?>
                            <div style="color:#ccc; text-align:center">N/A</div>
                        <?php endif ?>
                    </td>
                <?php endforeach ?>
            </tr>
        <?php endforeach ?>
        </tbody>
    </table>
<?php endforeach ?>
