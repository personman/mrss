<? /** @var \Mrss\Entity\College $college */ ?>

<script>
    <?php $this->headScript()->captureStart() ?>
    $(function() {
        $('.reportAccess').click(function() {
            var checked = $(this)[0].checked;

            if (checked) {
                checked = '1';
            } else {
                checked = '0';
            }

            var id = $(this).attr('id').split('_')
            var subscriptionId = id.pop()

            var url = '/memberships/report-access'
            var data = {
                subscriptionId: subscriptionId,
                checked: checked
            }


            $.post(url, data, function(data) {
                 if (data != 'ok') {
                     alert('Error saving report access setting.')
                 }
             })


        })
    })
    <?php $this->headScript()->captureEnd() ?>

</script>

<div class="btn-group heading-btns">
    <a class="btn btn-default" href="<?= $this->url('colleges/edit', array('id' => $college->getId())) ?>">
        <i class="glyphicon glyphicon-pencil"></i>
        Edit Institution</a>
    </a>
</div>

<h1><?= $college->getName() ?></h1>


<table class="style1">
    <tr>
        <td>
            IPEDS Unit ID:
        </td>
        <td>
            <?= $college->getIpeds() ?>
        </td>
    </tr>
    <tr>
        <td>
            OPE ID:
        </td>
        <td>
            <?= $college->getOpeId() ?>
        </td>
    </tr>

    <?php if ($system = $college->getSystem()): ?>
    <tr>
        <td>
            System:
        </td>
        <td>
            <?= $system->getName() ?>
        </td>
    </tr>
    <?php endif ?>

    <tr>
        <td>
            Address:
        </td>
        <td>
            <?= $college->getFullAddress() ?>
        </td>
    </tr>
    <tr>
        <td>
            Executive:
        </td>
        <td>
            <?= $college->getExecTitle() ?><br>
            <?= $college->getExecFullName() ?><br>
            <?= $college->getExecEmail() ?>
        </td>
    </tr>
    <tr>
        <td>
            Memberships:
        </td>
        <td>
            <table class="table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Study</th>
                        <th>Completion</th>
                        <th>Suppressions</th>
                        <?php if (!empty($studyConfig->college_report_access_checkbox)): ?>
                            <th>Report Access</th>
                        <?php endif ?>

                        <?php if ($this->currentStudy()->hasSections()): ?>
                            <th>Modules</th>
                        <?php endif ?>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($college->getSubscriptionsForStudy($this->currentStudy()) as $subscription): ?>
                    <tr>
                        <td>
                            <?= $subscription->getYear() ?>
                        </td>
                        <td>
                            <?= $subscription->getStudy()->getName() ?>
                        </td>
                        <td>
                            <a href="<?= $this->url(
                                'observation',
                                array('id' => $subscription->getObservation()->getId())
                            ) ?>">
                                <?= $subscription->getCompletion() ?>%
                            </a>
                        </td>
                        <td>
                            <?php if ($suppressions = $subscription->getSuppressionList()): ?>

                                <?= $suppressions ?>

                            <?php endif ?>
                            &nbsp;&nbsp;
                            <a href="<?= $this->url('suppressions/edit', array('subscription' => $subscription->getId())) ?>">
                                Manage Suppressions
                            </a>
                        </td>

                        <?php if (!empty($studyConfig->college_report_access_checkbox)): ?>
                            <?php $id = $subscription->getId(); ?>

                            <td style="text-align:center">
                                <input type="checkbox" name="report_access[<?= $id ?>]" title="Saves automatically." id="reportAccess_<?= $id ?>" class="reportAccess" <?php if ($subscription->getReportAccess()) echo 'checked="checked"' ?> />
                            </td>
                        <?php endif ?>

                        <?php if ($this->currentStudy()->hasSections()): ?>
                            <td>
                                <?= $subscription->getSectionNames(); ?>
                            </td>
                        <?php endif ?>

                    </tr>
                    <?php endforeach ?>
                </tbody>

            </table>

            <a href="/admin/changes/<?= $college->getId() ?>">Recent Data Changes</a>
        </td>
    </tr>
    <tr>
        <td>
            Users:
        </td>
        <td>
            <ul>
                <?php foreach ($college->getUsers() as $user): ?>
                    <li>
                        <a title="Impersonate this user"
                           href="/admin/user/impersonate/<?= $user->getId() ?>">
                            <i class="icon icon-fire glyphicon glyphicon-transfer"></i></a>
                        <a href="<?= $this->url(
                            'users/edit',
                            array('id' => $user->getId())
                        ) ?>"><?= $user->getFullName() ?></a>
                        (<?= $user->getRole() ?>)

                        <?php if ($user->getLastAccess()): ?>
                            (<?= $user->getLastAccess()->format('Y-m-d') ?>)
                        <?php endif ?>
                    </li>
                <?php endforeach ?>
            </ul>

            <a href="<?= $this->url('users/edit', array('id' => 'add', 'college' => $college->getId())) ?>" class="btn btn-default">
                <span class="glyphicon glyphicon-plus icon icon-plus"></span>
                Add User
            </a>
        </td>
    </tr>
</table>
