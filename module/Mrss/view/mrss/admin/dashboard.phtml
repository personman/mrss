<?php /** @var \Mrss\Entity\Subscription[] $subscriptions */ ?>

<a href="/admin/changes">Recent data changes</a>

<h2>Subscriptions</h2>

<?php if (count($subscriptions)): ?>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Completion</th>
            <th>Institution</th>
            <th>Users</th>
            <th>Subscription Date</th>
            <th>Payment Method</th>
            <th>Payment Amount</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <?php $total = 0; ?>
        <?php foreach ($subscriptions as $subscription): ?>
            <?php $total += $subscription->getPaymentAmount() ?>
            <tr>
                <td>
                    <a href="<?= $this->url(
                        'observation',
                        array('id' => $subscription->getObservation()->getId())
                    ) ?>">
                        <?= $this->currentStudy()->getCompletionPercentage(
                            $subscription->getObservation()
                        ) ?>%
                    </a>
                </td>
                <td>
                    <a href="<?= $this->url(
                        'colleges/view',
                        array('id' => $subscription->getCollege()->getId())
                    ) ?>">
                        <?= $subscription->getCollege()->getName() ?>
                    </a>
                </td>

                <td>
                    <?php
                        $userList = array();
                        foreach ($subscription->getCollege()->getUsers() as $user):
                            $name = $user->getFullName();

                            // Wrap in a link
                            $url = $this->url(
                                'users/edit',
                                array('id' => $user->getId())
                            );
                            $item = '<a title="Impersonate this user"
                                href="/admin/user/impersonate/' . $user->getId()
                                . '"><i class="icon icon-fire"></i></a> ';
                            $item .= "<a href='$url'>$name</a>";

                            if ($access = $user->getLastAccess()) {
                                $date = $access->format('Y-m-d H:i');
                                $item .= " ($date)";
                            }
                            $userList[] = $item;
                        endforeach;

                        echo implode('<br>', $userList);

                    ?>
                </td>

                <td>
                    <?= $subscription->getCreated()->format('Y-m-d') ?>
                </td>
                <td>
                    <?= $subscription->getPaymentMethodForDisplay() ?>
                </td>
                <td>
                    $<?= number_format($subscription->getPaymentAmount(), 2) ?>
                </td>
                <td>
                    <a href="<?= $this->url(
                        'subscription-delete',
                        array('id' => $subscription->getId())
                    ) ?>" class="deleteLink">
                        delete
                    </a>
                </td>
            </tr>
        <?php endforeach ?>
    </tbody>
</table>

<p>
    <?= count($subscriptions) ?> subscriptions, $<?= number_format($total, 2) ?>.
</p>

<?php else: ?>
    <p>No one has signed up yet.</p>
<?php endif ?>
